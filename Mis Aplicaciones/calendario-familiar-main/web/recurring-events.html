<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FamilySync">
    <meta name="theme-color" content="#1B5E20">
    <title>Eventos Recurrentes - FamilySync</title>
    <link rel="apple-touch-icon" href="icons/Icon-192.png">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: rgba(255, 255, 255, 0.2);
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
        }

        body {
            background: #f5f5f5;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: #1B5E20;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .back-btn:active {
            background: rgba(255, 255, 255, 0.3);
        }

        .header-title {
            font-size: 16px;
            font-weight: bold;
            color: white;
            flex: 1;
        }

        .content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            -webkit-overflow-scrolling: touch;
        }

        .section {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 14px;
            font-weight: bold;
            color: #1B5E20;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            background: white;
        }

        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #1B5E20;
            box-shadow: 0 0 0 3px rgba(27, 94, 32, 0.1);
        }

        .btn {
            background: #1B5E20;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            width: 100%;
        }

        .btn:active {
            background: #0F4C14;
        }

        .btn-secondary {
            background: #666;
        }

        .events-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .event-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            background: #fafafa;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .event-item:last-child {
            margin-bottom: 0;
        }

        .event-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .event-details {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }

        .event-recurrence {
            display: inline-block;
            background: #1B5E20;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-right: 4px;
        }

        .event-actions {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            background: transparent;
            border: none;
            font-size: 16px;
            cursor: pointer;
            padding: 6px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .btn-delete {
            color: #f44336;
        }

        .btn-delete:active {
            background: rgba(244, 67, 54, 0.1);
        }

        .btn-edit {
            color: #1B5E20;
        }

        .btn-edit:active {
            background: rgba(27, 94, 32, 0.1);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .empty-state-text {
            font-size: 14px;
        }

        .recurrence-options {
            display: none;
            margin-top: 12px;
            padding: 12px;
            background: #f9f9f9;
            border-radius: 8px;
        }

        .recurrence-options.show {
            display: block;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-item label {
            font-size: 13px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <button class="back-btn" onclick="goBack()">‚óÄ</button>
        <div class="header-title">üîÑ Eventos Recurrentes</div>
    </div>

    <!-- Content -->
    <div class="content">
        <!-- Formulario de Nuevo Evento -->
        <div class="section">
            <div class="section-title">Agregar Evento Recurrente</div>
            
            <div class="form-group">
                <label class="form-label">T√≠tulo</label>
                <input type="text" id="eventTitle" class="form-input" placeholder="Ej: Reuni√≥n semanal">
            </div>

            <div class="form-group">
                <label class="form-label">Descripci√≥n</label>
                <textarea id="eventDescription" class="form-textarea" placeholder="Detalles del evento"></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Fecha de Inicio</label>
                <input type="date" id="startDate" class="form-input">
            </div>

            <div class="form-group">
                <label class="form-label">Fecha de Fin (opcional)</label>
                <input type="date" id="endDate" class="form-input">
            </div>

            <div class="form-group">
                <label class="form-label">Hora</label>
                <input type="time" id="eventTime" class="form-input">
            </div>

            <div class="form-group">
                <label class="form-label">Frecuencia</label>
                <select id="recurrenceType" class="form-select" onchange="toggleRecurrenceOptions()">
                    <option value="">No recurrente</option>
                    <option value="daily">Diario</option>
                    <option value="weekly">Semanal</option>
                    <option value="monthly">Mensual</option>
                    <option value="yearly">Anual</option>
                    <option value="custom">Personalizada</option>
                </select>
            </div>

            <!-- Opciones de recurrencia personalizada -->
            <div id="recurrenceOptions" class="recurrence-options">
                <div class="form-label">Repetir cada:</div>
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 8px;">
                    <input type="number" id="recurrenceInterval" class="form-input" value="1" min="1">
                    <select id="recurrenceUnit" class="form-select">
                        <option value="days">d√≠a(s)</option>
                        <option value="weeks">semana(s)</option>
                        <option value="months">mes(es)</option>
                    </select>
                </div>

                <div class="form-label" style="margin-top: 12px;">D√≠as de la semana (solo si es semanal):</div>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="day0" value="0">
                        <label for="day0">Dom</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="day1" value="1">
                        <label for="day1">Lun</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="day2" value="2">
                        <label for="day2">Mar</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="day3" value="3">
                        <label for="day3">Mi√©</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="day4" value="4">
                        <label for="day4">Jue</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="day5" value="5">
                        <label for="day5">Vie</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="day6" value="6">
                        <label for="day6">S√°b</label>
                    </div>
                </div>
            </div>

            <button class="btn" id="submitBtn" onclick="addRecurringEvent()">‚ûï Crear Evento</button>
            <button class="btn btn-secondary" id="cancelBtn" onclick="cancelEdit()" style="display:none; margin-top: 8px;">Cancelar</button>
        </div>

        <!-- Lista de Eventos Recurrentes -->
        <div class="section">
            <div class="section-title">Eventos Recurrentes Activos</div>
            <div class="events-list" id="eventsList">
                <div class="empty-state">
                    <div class="empty-state-icon">üì≠</div>
                    <div class="empty-state-text">No hay eventos recurrentes configurados</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB5vvp7IQOZLO7LlsUY_Wq-H8M_5PH3ZQE",
            authDomain: "apptaxi-f2190.firebaseapp.com",
            projectId: "apptaxi-f2190",
            storageBucket: "apptaxi-f2190.firebasestorage.app",
            messagingSenderId: "804273724178",
            appId: "1:804273724178:web:c5955a1f657884c0e7f1cb",
            measurementId: "G-3D8R30TYTM"
        };

        let db;
        let recurringEvents = [];
        let editingEventId = null;
        let isFirebaseConnected = false;
        let currentUserId = 1; // Usuario por defecto

        function init() {
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                isFirebaseConnected = true;
                
                // Cargar usuario guardado
                const savedUserId = localStorage.getItem('current_user_id');
                if (savedUserId) {
                    currentUserId = parseInt(savedUserId);
                }
                
                console.log('‚úÖ Firebase inicializado');
                loadRecurringEvents();
            } catch (error) {
                console.error('‚ùå Error inicializando Firebase:', error);
            }
        }

        async function loadRecurringEvents() {
            try {
                const snapshot = await db.collection('recurring_events')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                recurringEvents = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                renderEvents();
            } catch (error) {
                console.error('Error cargando eventos recurrentes:', error);
            }
        }

        function renderEvents() {
            const container = document.getElementById('eventsList');
            
            if (recurringEvents.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <div class="empty-state-text">No hay eventos recurrentes configurados</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = recurringEvents.map(event => {
                const startDate = event.startDate.toDate();
                const endDate = event.endDate ? event.endDate.toDate() : null;
                
                return `
                    <div class="event-item">
                        <div class="event-title">${event.title}</div>
                        <div class="event-details">
                            üìÖ ${formatDate(startDate)}${endDate ? ' - ' + formatDate(endDate) : ' (sin fin)'} | ‚è∞ ${formatTime(event.time)}<br>
                            ${event.description || 'Sin descripci√≥n'}
                        </div>
                        <div>
                            <span class="event-recurrence">${getRecurrenceLabel(event)}</span>
                        </div>
                        <div class="event-actions" style="margin-top: 8px;">
                            <button class="btn-icon btn-edit" onclick="editEvent('${event.id}')">‚úèÔ∏è</button>
                            <button class="btn-icon btn-delete" onclick="deleteEvent('${event.id}')">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function addRecurringEvent() {
            const title = document.getElementById('eventTitle').value;
            const description = document.getElementById('eventDescription').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const time = document.getElementById('eventTime').value;
            const recurrenceType = document.getElementById('recurrenceType').value;

            if (!title || !startDate || !time || !recurrenceType) {
                alert('Por favor completa todos los campos obligatorios');
                return;
            }

            try {
                // Crear fecha de inicio usando solo la fecha (sin considerar la hora actual)
                // Agregar 'Z' al final para forzar UTC y evitar problemas de zona horaria
                const startDateTime = new Date(`${startDate}T${time}:00`);
                console.log('üìÖ Creando evento con fecha:', startDate, 'hora:', time, 'Date:', startDateTime.toISOString());
                
                const eventData = {
                    title: title,
                    description: description || '',
                    startDate: firebase.firestore.Timestamp.fromDate(startDateTime),
                    time: time,
                    recurrenceType: recurrenceType
                };
                
                console.log('üìÖ startDate guardado (Timestamp):', eventData.startDate.toDate().toISOString());

                if (endDate) {
                    const endDateTime = new Date(`${endDate}T${time}:00`);
                    eventData.endDate = firebase.firestore.Timestamp.fromDate(endDateTime);
                }

                // Configuraci√≥n de recurrencia personalizada
                if (recurrenceType === 'custom') {
                    eventData.customInterval = parseInt(document.getElementById('recurrenceInterval').value);
                    eventData.customUnit = document.getElementById('recurrenceUnit').value;
                    
                    // D√≠as de la semana seleccionados
                    const selectedDays = [];
                    for (let i = 0; i <= 6; i++) {
                        const checkbox = document.getElementById(`day${i}`);
                        if (checkbox.checked) {
                            selectedDays.push(i);
                        }
                    }
                    if (selectedDays.length > 0) {
                        eventData.customDaysOfWeek = selectedDays;
                    }
                }

                if (editingEventId) {
                    // Actualizar evento existente
                    // Obtener el evento original para comparar
                    const originalEvent = recurringEvents.find(e => e.id === editingEventId);
                    
                    // Construir objeto de actualizaci√≥n
                    const startDateTime = new Date(`${startDate}T${time}:00`);
                    console.log('üìÖ Actualizando evento con fecha:', startDate, 'hora:', time, 'Date:', startDateTime.toISOString());
                    
                    const updateData = {
                        title: title,
                        description: description || '',
                        startDate: firebase.firestore.Timestamp.fromDate(startDateTime),
                        time: time,
                        recurrenceType: recurrenceType,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    console.log('üìÖ startDate actualizado (Timestamp):', updateData.startDate.toDate().toISOString());
                    
                    if (endDate) {
                        const endDateTime = new Date(`${endDate}T${time}:00`);
                        updateData.endDate = firebase.firestore.Timestamp.fromDate(endDateTime);
                    } else {
                        // Si no hay endDate y antes exist√≠a, eliminarlo
                        if (originalEvent && originalEvent.endDate) {
                            updateData.endDate = firebase.firestore.FieldValue.delete();
                        }
                    }
                    
                    // Configuraci√≥n de recurrencia personalizada
                    if (recurrenceType === 'custom') {
                        updateData.customInterval = parseInt(document.getElementById('recurrenceInterval').value);
                        updateData.customUnit = document.getElementById('recurrenceUnit').value;
                        
                        // D√≠as de la semana seleccionados
                        const selectedDays = [];
                        for (let i = 0; i <= 6; i++) {
                            const checkbox = document.getElementById(`day${i}`);
                            if (checkbox.checked) {
                                selectedDays.push(i);
                            }
                        }
                        if (selectedDays.length > 0) {
                            updateData.customDaysOfWeek = selectedDays;
                        } else {
                            updateData.customDaysOfWeek = firebase.firestore.FieldValue.delete();
                        }
                    } else {
                        // Si cambi√≥ de custom a otro tipo, eliminar campos personalizados
                        if (originalEvent && originalEvent.recurrenceType === 'custom') {
                            updateData.customInterval = firebase.firestore.FieldValue.delete();
                            updateData.customUnit = firebase.firestore.FieldValue.delete();
                            updateData.customDaysOfWeek = firebase.firestore.FieldValue.delete();
                        }
                    }
                    
                    await db.collection('recurring_events').doc(editingEventId).update(updateData);
                    
                    alert('‚úÖ Evento actualizado exitosamente');
                    cancelEdit();
                    
                    // Redirigir a calendar.html para ver los cambios
                    window.location.href = 'calendar.html';
                } else {
                    // Crear nuevo evento
                    eventData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('recurring_events').add(eventData);
                    
                    alert('‚úÖ Evento recurrente creado exitosamente');
                }

                // Limpiar formulario
                document.getElementById('eventTitle').value = '';
                document.getElementById('eventDescription').value = '';
                document.getElementById('startDate').value = '';
                document.getElementById('endDate').value = '';
                document.getElementById('eventTime').value = '';
                document.getElementById('recurrenceType').value = '';
                document.getElementById('recurrenceOptions').classList.remove('show');
                
                // Limpiar checkboxes
                for (let i = 0; i <= 6; i++) {
                    document.getElementById(`day${i}`).checked = false;
                }

                loadRecurringEvents();
            } catch (error) {
                console.error('Error guardando evento:', error);
                alert('‚ùå Error al guardar evento');
            }
        }

        async function deleteEvent(id) {
            if (!confirm('¬øEliminar este evento recurrente?')) return;

            try {
                await db.collection('recurring_events').doc(id).delete();
                
                loadRecurringEvents();
            } catch (error) {
                console.error('Error eliminando evento:', error);
                alert('‚ùå Error al eliminar evento');
            }
        }
        function editEvent(id) {
            const event = recurringEvents.find(e => e.id === id);
            if (!event) return;

            // Cargar datos en el formulario
            document.getElementById('eventTitle').value = event.title;
            document.getElementById('eventDescription').value = event.description || '';
            
            // Formatear fechas para input type="date" (YYYY-MM-DD)
            const startDate = event.startDate.toDate();
            document.getElementById('startDate').value = formatDateForInput(startDate);
            
            if (event.endDate) {
                const endDate = event.endDate.toDate();
                document.getElementById('endDate').value = formatDateForInput(endDate);
            } else {
                document.getElementById('endDate').value = '';
            }
            
            document.getElementById('eventTime').value = event.time;
            document.getElementById('recurrenceType').value = event.recurrenceType;
            toggleRecurrenceOptions();

            // Cargar opciones personalizadas si existen
            if (event.recurrenceType === 'custom') {
                document.getElementById('recurrenceInterval').value = event.customInterval || 1;
                document.getElementById('recurrenceUnit').value = event.customUnit || 'days';
                
                // Marcar d√≠as seleccionados
                if (event.customDaysOfWeek) {
                    for (let i = 0; i <= 6; i++) {
                        const checkbox = document.getElementById(`day${i}`);
                        checkbox.checked = event.customDaysOfWeek.includes(i);
                    }
                }
            }

            // Cambiar a modo edici√≥n
            editingEventId = id;
            document.getElementById('submitBtn').textContent = 'üíæ Guardar Cambios';
            document.getElementById('cancelBtn').style.display = 'block';
            
            // Scroll al formulario
            document.querySelector('.section').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelEdit() {
            editingEventId = null;
            document.getElementById('submitBtn').textContent = '‚ûï Crear Evento';
            document.getElementById('cancelBtn').style.display = 'none';
            
            // Limpiar formulario
            document.getElementById('eventTitle').value = '';
            document.getElementById('eventDescription').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('eventTime').value = '';
            document.getElementById('recurrenceType').value = '';
            document.getElementById('recurrenceOptions').classList.remove('show');
            
            // Limpiar checkboxes de d√≠as
            for (let i = 0; i <= 6; i++) {
                document.getElementById(`day${i}`).checked = false;
            }
        }

        function formatDateForInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function toggleRecurrenceOptions() {
            const type = document.getElementById('recurrenceType').value;
            const options = document.getElementById('recurrenceOptions');
            
            if (type === 'custom') {
                options.classList.add('show');
            } else {
                options.classList.remove('show');
            }
        }

        function getRecurrenceLabel(event) {
            const types = {
                'daily': 'Diario',
                'weekly': 'Semanal',
                'monthly': 'Mensual',
                'yearly': 'Anual',
                'custom': `Personalizada (cada ${event.customInterval || 1} ${event.customUnit || 'd√≠as'})`
            };
            return types[event.recurrenceType] || 'No recurrente';
        }

        function formatDate(date) {
            return date.toLocaleDateString('es-ES', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric' 
            });
        }

        function formatTime(time) {
            if (typeof time === 'string') return time;
            const [h, m] = time.split(':');
            return `${h.padStart(2, '0')}:${m.padStart(2, '0')}`;
        }

        function goBack() {
            window.location.href = 'calendar.html';
        }

        init();
    </script>
</body>
</html>

