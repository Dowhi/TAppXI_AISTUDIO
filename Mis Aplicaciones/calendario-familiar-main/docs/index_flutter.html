<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <meta content="IE=Edge" http-equiv="X-UA-Compatible" />
  <meta name="description" content="FamilySync - Calendario familiar" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <!-- iOS Safari specific meta tags -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="FamilySync" />

  <!-- Flutter requires this exact placeholder if --base-href is provided -->
  <base href="/calendario-familiar/" />

  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <title>FamilySync</title>

  <link rel="manifest" href="manifest.json" />
  <link rel="icon" type="image/png" href="icons/Icon-192.png" />
  <link rel="apple-touch-icon" href="icons/Icon-192.png" />

  <!-- Flutter loader -->
  <script src="flutter.js" defer></script>

  <style>
    html,
    body {
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    body {
      margin: 0;
      background: #1B5E20;
      overflow: hidden;
      -webkit-overflow-scrolling: touch;
    }

    #loading {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-family: -apple-system, BlinkMacSystemFont, system-ui, Segoe UI, Roboto, Arial;
      color: #ffffff;
      background: linear-gradient(135deg, #1B5E20, #2E7D32, #388E3C);
    }

    #loading .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    #loading .text {
      font-size: 18px;
      font-weight: 500;
    }
  </style>
</head>

<body>
  <div id="loading">
    <div class="spinner"></div>
    <div class="text">Cargando FamilySync‚Ä¶</div>
  </div>

  <script>
    // Detectar iOS Safari
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
    const isIOSSafari = isIOS && isSafari;

    console.log('üîç Detector:', { isIOS, isSafari, isIOSSafari });
    console.log('üì± User Agent:', navigator.userAgent);

    // REDIRECCI√ìN INMEDIATA para iOS Safari
    if (isIOSSafari) {
      console.log('üîÑ iOS Safari detectado - Redirigiendo a versi√≥n compatible...');
      window.location.href = 'iphone.html';
    }

    if (isIOSSafari) {
      console.log('üì± iOS Safari detectado - Aplicando configuraci√≥n optimizada');
    }

    window.addEventListener('load', function () {
      console.log('‚úÖ P√°gina cargada, iniciando Flutter...');

      // Timeout de seguridad para iOS
      let flutterLoaded = false;
      const loadingTimeout = setTimeout(function () {
        if (!flutterLoaded) {
          console.error('‚ùå Flutter no carg√≥ en 10 segundos');
          const loadingDiv = document.getElementById('loading');
          if (loadingDiv) {
            loadingDiv.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                  <div style="font-size: 24px; margin-bottom: 20px;">‚ö†Ô∏è</div>
                  <div style="font-size: 18px; margin-bottom: 10px;">Error de carga</div>
                  <div style="font-size: 14px; opacity: 0.8; margin-bottom: 20px;">
                    La aplicaci√≥n no se pudo cargar correctamente
                  </div>
                  <button onclick="location.reload()" style="
                    background: white;
                    color: #1B5E20;
                    border: none;
                    padding: 12px 24px;
                    border-radius: 8px;
                    font-size: 16px;
                    font-weight: bold;
                    cursor: pointer;
                  ">Reintentar</button>
                </div>
              `;
          }
        }
      }, 10000);

      try {
        // Configuraci√≥n espec√≠fica para iOS Safari
        const config = {
          serviceWorker: {
            serviceWorkerVersion: null,
          }
        };

        if (isIOSSafari) {
          console.log('üîß Usando configuraci√≥n para iOS Safari');
          config.renderer = 'canvaskit'; // Usar CanvasKit para mejor compatibilidad
        }

        // Verificar que _flutter est√© disponible
        if (!window._flutter || !window._flutter.loader) {
          throw new Error('Flutter loader no est√° disponible');
        }

        // Load Flutter entrypoint
        _flutter.loader
          .loadEntrypoint(config)
          .then(function (engineInitializer) {
            console.log('‚úÖ Flutter entrypoint cargado');

            // Verificar que engineInitializer sea v√°lido
            if (!engineInitializer || !engineInitializer.initializeEngine) {
              throw new Error('Engine initializer no es v√°lido');
            }

            return engineInitializer.initializeEngine({
              renderer: isIOSSafari ? 'html' : 'auto'  // Cambiar a html para iOS
            });
          })
          .then(function (appRunner) {
            console.log('‚úÖ Flutter engine inicializado');
            flutterLoaded = true;
            clearTimeout(loadingTimeout);

            // Verificar que appRunner sea v√°lido
            if (!appRunner || !appRunner.runApp) {
              throw new Error('App runner no es v√°lido');
            }

            // Remover loading con delay para iOS
            setTimeout(function () {
              const loadingDiv = document.getElementById('loading');
              if (loadingDiv) {
                loadingDiv.remove();
              }
            }, isIOSSafari ? 1000 : 100);  // M√°s tiempo para iOS

            return appRunner.runApp();
          })
          .then(function () {
            console.log('‚úÖ Flutter app ejecut√°ndose');
          })
          .catch(function (error) {
            console.error('‚ùå Error cargando Flutter:', error);
            flutterLoaded = true;
            clearTimeout(loadingTimeout);

            // Para iOS Safari, redirigir autom√°ticamente a la versi√≥n simplificada
            if (isIOSSafari) {
              console.log('üîÑ Redirigiendo a versi√≥n iOS simplificada...');
              window.location.href = 'iphone.html';
              return;
            }

            const loadingDiv = document.getElementById('loading');
            if (loadingDiv) {
              loadingDiv.innerHTML = `
                  <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 24px; margin-bottom: 20px;">‚ùå</div>
                    <div style="font-size: 18px; margin-bottom: 10px;">Error de compatibilidad</div>
                    <div style="font-size: 14px; opacity: 0.8; margin-bottom: 10px;">
                      ${error.message || 'Error desconocido'}
                    </div>
                    <div style="font-size: 12px; opacity: 0.6; margin-bottom: 20px;">
                      ${isIOS ? 'Redirigiendo a versi√≥n compatible...' : 'Por favor, intenta actualizar tu navegador'}
                    </div>
                    <button onclick="location.href='iphone.html'" style="
                      background: white;
                      color: #1B5E20;
                      border: none;
                      padding: 12px 24px;
                      border-radius: 8px;
                      font-size: 16px;
                      font-weight: bold;
                      cursor: pointer;
                      margin: 5px;
                    ">Versi√≥n iOS</button>
                    <button onclick="location.reload()" style="
                      background: white;
                      color: #1B5E20;
                      border: none;
                      padding: 12px 24px;
                      border-radius: 8px;
                      font-size: 16px;
                      font-weight: bold;
                      cursor: pointer;
                      margin: 5px;
                    ">Reintentar</button>
                  </div>
                `;

              // Auto-redirect para iOS despu√©s de 2 segundos
              if (isIOS) {
                setTimeout(function () {
                  window.location.href = 'iphone.html';
                }, 2000);
              }
            }
          });
      } catch (error) {
        console.error('‚ùå Error fatal:', error);
        const loadingDiv = document.getElementById('loading');
        if (loadingDiv) {
          loadingDiv.innerHTML = `
              <div style="text-align: center; padding: 20px;">
                <div style="font-size: 24px; margin-bottom: 20px;">üí•</div>
                <div style="font-size: 18px; margin-bottom: 10px;">Error fatal</div>
                <div style="font-size: 14px; opacity: 0.8; margin-bottom: 20px;">
                  ${error.message || 'Error cr√≠tico en la carga'}
                </div>
                <button onclick="location.reload()" style="
                  background: white;
                  color: #1B5E20;
                  border: none;
                  padding: 12px 24px;
                  border-radius: 8px;
                  font-size: 16px;
                  font-weight: bold;
                  cursor: pointer;
                ">Reintentar</button>
              </div>
            `;
        }
      }
    });
  </script>
</body>

</html>